<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Future Age → Bitcoin Epoch</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    label { display: block; margin-top: 1.5em; }
    input[type="range"] { width: 100%; }
    table { border-collapse: collapse; margin-top: 1em; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 0.5em; }
    th { text-align: left; background: #f9f9f9; width: 40%; }
    #debug { color: #999; font-size: 0.8em; margin-top: 1em; }
  </style>
</head>
<body>
  <h1>Bitcoin Epoch at Your Future Age</h1>

  <label>
    Enter your <strong>current age</strong>:
    <input type="number" id="current-age" min="0" max="150" placeholder="e.g. 30" />
  </label>

  <label>
    Slide to your <strong>future age</strong>:
    <input type="range" id="future-age" min="0" max="150" disabled />
    <span id="future-age-display">—</span> years old
  </label>

  <div id="epoch-info"></div>
  <div id="debug"></div>

  <script>
    const DEBUG = msg => {
      console.log(msg);
      document.getElementById('debug').textContent = msg;
    };

    let epochData = [];
    let dataLoaded = false;

    // 1) Load CSV (no spaces in filename)
    fetch('epochs.csv')
      .then(r => {
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.text();
      })
      .then(csv => {
        DEBUG('CSV loaded, parsing…');
        const [headerLine, ...lines] = csv.trim().split('\n');
        const headers = headerLine.split(',').map(h => h.trim().replace(/^"|"$/g,''));
        epochData = lines.map(line => {
          const cols = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
          const obj = {};
          headers.forEach((h,i) => obj[h] = (cols[i]||'').replace(/^"|"$/g,'').trim());
          return obj;
        });
        dataLoaded = true;
        DEBUG(`Parsed ${epochData.length} epochs`);
        // If user already entered age, re-run update to show table immediately
        update();
      })
      .catch(err => DEBUG('Error loading CSV: ' + err));

    // 2) Wire up controls
    const ageInput = document.getElementById('current-age');
    const slider   = document.getElementById('future-age');
    const display  = document.getElementById('future-age-display');
    const infoDiv  = document.getElementById('epoch-info');

    ageInput.addEventListener('input', () => {
      const cur = parseInt(ageInput.value, 10);
      if (!isNaN(cur) && cur >= 0 && cur <= 150) {
        slider.disabled = false;
        slider.min = cur;
        slider.value = cur;
        update();
      } else {
        slider.disabled = true;
        display.textContent = '—';
        infoDiv.innerHTML = '';
      }
    });

    slider.addEventListener('input', update);

    function update() {
      const curAge = parseInt(ageInput.value, 10);
      const futAge = parseInt(slider.value, 10);
      if (isNaN(curAge) || isNaN(futAge)) return;

      display.textContent = futAge;
      const currentYear = new Date().getFullYear();
      const birthYear   = currentYear - curAge;
      const targetYear  = birthYear + futAge;

      DEBUG(`Target year: ${targetYear}`);

      if (!dataLoaded) {
        DEBUG('Waiting for CSV…');
        return;
      }

      // pick the latest epoch whose Year ≤ targetYear
      const recs = epochData.filter(e => +e.['연도'] <= targetYear);
      const entry = recs.length
        ? recs[recs.length - 1]
        : epochData[0];

      renderTable(entry, targetYear);
      DEBUG(`Showing epoch for Year=${entry.['연도']}`);
    }

    function renderTable(entry, targetYear) {
      let html = '<table>';
      for (const key in entry) {
        let value = entry[key];
        if (key === '연도') {
          value = targetYear; // override with actual year
        }
        html += `<tr><th>${key}</th><td>${entry[key]}</td></tr>`;
      }
      html += '</table>';
      infoDiv.innerHTML = html;
    }
  </script>
</body>
</html>
