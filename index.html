
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>내 미래 나이에 비트코인은?</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    label { display: block; margin-top: 1.5em; }
    input[type="range"] { width: 100%; }
    table { border-collapse: collapse; margin-top: 1em; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 0.5em; }
    th { text-align: left; background: #f9f9f9; width: 40%; }
    #debug { color: #999; font-size: 0.8em; margin-top: 1em; }

    .tooltip-trigger {
      margin-left: 0.3em;
      cursor: pointer; /* Use pointer cursor for clickable elements */
      font-size: 0.9em;
      color: #666;
      border-bottom: 1px dotted #666; /* Keep dotted border for visual cue */
      position: relative; /* Needed for positioning the tooltip content */
      display: inline-block; /* Allows margin-left and correct positioning */
    }
    
    .tooltip-content {
      position: absolute;
      left: 50%;
      transform: translateX(-50%); /* Center the tooltip */
      bottom: 125%; /* Position above the icon */
      background-color: #333; /* Dark background */
      color: #fff; /* White text */
      padding: 5px 8px;
      border-radius: 4px;
      white-space: nowrap; /* Prevent text from wrapping */
      z-index: 10; /* Ensure it appears above other content */
      opacity: 0; /* Start hidden */
      visibility: hidden; /* Start hidden */
      transition: opacity 0.3s, visibility 0.3s; /* Smooth transition */
      pointer-events: none; /* Prevents interaction with hidden tooltip */
    
      /* Add max-width for long hints to wrap */
      max-width: 200px; /* Adjust as needed */
      white-space: normal; /* Allow text to wrap within max-width */
      text-align: center;
    }
    
    /* Arrow for the tooltip */
    .tooltip-content::after {
      content: '';
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 100%; /* Position below the content */
      border-width: 5px;
      border-style: solid;
      border-color: #333 transparent transparent transparent; /* Creates a downward-pointing arrow */
    }
    
    /* Show tooltip when the parent .tooltip-trigger has the 'active' class */
    .tooltip-trigger.active .tooltip-content {
      opacity: 1;
      visibility: visible;
    }
  </style>
</head>
<body>
  <h1>내 미래 나이에 비트코인은?</h1>

  <label>
    <strong>현재 나이</strong>를 입력하세요:
    <input type="number" id="current-age" min="0" max="150" placeholder="e.g. 30" />
  </label>

  <label>
    <strong>미래 나이</strong>로 슬라이드 해보세요:
    <input type="range" id="future-age" min="0" max="150" disabled />
    내 미래 나이: <span id="future-age-display">—</span> 살
  </label>

  <div id="epoch-info"></div>
  <label>
    <strong>가정하는</strong> BTC 수량을 입력해주세요:
    <input type="number" id="btc-amount" min="0" step="any" placeholder="e.g. 0.5" disabled />
  </label>
  <div id="percentage-info"></div>
  <div id="explanation"></div>
  <div id="debug"></div>

  <script>
    const DEBUG = msg => {
      console.log(msg);
      document.getElementById('debug').textContent = msg;
    };

    let epochData = [];
    let dataLoaded = false;

    // 1) Load CSV
    fetch('epochs.csv')
      .then(r => {
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.text();
      })
      .then(csv => {
        DEBUG('CSV loaded, parsing…');
        const [headerLine, ...lines] = csv.trim().split('\n');
        const headers = headerLine.split(',').map(h => h.trim().replace(/^"|"$/g, ''));
        epochData = lines.map(line => {
          const cols = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
          const obj = {};
          headers.forEach((h, i) => obj[h] = (cols[i]||'').replace(/^"|"$/g, '').trim());
          return obj;
        });
        dataLoaded = true;
        DEBUG(`Parsed ${epochData.length} epochs`);
        update();
      })
      .catch(err => DEBUG('Error loading CSV: ' + err));

    // 2) Wire up controls
    const ageInput       = document.getElementById('current-age');
    const slider         = document.getElementById('future-age');
    const display        = document.getElementById('future-age-display');
    const btcInput       = document.getElementById('btc-amount');
    const infoDiv        = document.getElementById('epoch-info');
    const percentageDiv  = document.getElementById('percentage-info');
    const tooltipTriggers = infoDiv.querySelectorAll('.tooltip-trigger');
    let activeTooltip = null; // To keep track of the currently open tooltip

    ageInput.addEventListener('input', () => {
      const cur = parseInt(ageInput.value, 10);
      if (!isNaN(cur) && cur >= 0 && cur <= 150) {
        slider.disabled   = false;
        btcInput.disabled = false;
        slider.min        = cur;
        slider.value      = cur;
        update();
      } else {
        slider.disabled   = true;
        btcInput.disabled = true;
        display.textContent = '—';
        infoDiv.innerHTML   = '';
        percentageDiv.innerHTML = '';
      }
    });

    slider.addEventListener('input', update);
    btcInput.addEventListener('input', update);

    function update() {
      const curAge = parseInt(ageInput.value, 10);
      const futAge = parseInt(slider.value, 10);
      if (isNaN(curAge) || isNaN(futAge)) return;

      display.textContent = futAge;
      const currentYear = new Date().getFullYear();
      const birthYear   = currentYear - curAge;
      const targetYear  = birthYear + futAge;

      DEBUG(`Target year: ${targetYear}`);
      if (!dataLoaded) return DEBUG('Waiting for CSV…');

      // pick latest epoch whose 연도 ≤ targetYear
      const recs = epochData.filter(e => +e['반감기 시작 연도'] <= targetYear);
      const entry = recs.length ? recs[recs.length - 1] : epochData[0];

      renderTable(entry);
      renderPercentTable(entry);
      DEBUG(`Rendered epoch ${entry['반감기 시작 연도']} at 연도=${targetYear}`);
    }

    function renderTable(entry) {
      let html = '<table>';
      const hints = {
        '반감기 시작 연도': '반감기가 시작한 해',
        '반감기': '몇번째 반감기',
        '블록높이': '반감기가 시작된 블록높이',
        '채굴보상(btc)': '약 4년 반감기 동안의 채굴보상',
        '채굴보상(sats)': '약 4년 반감기 동안의 채굴보상',
        '총채굴량': '반감기가 시작했을 시점의 총채굴량',
        '총채굴량(%)': '반감기가 시작했을 시점의 총채굴량 비율',
        '미채굴량(총)': '반감기가 시작했을 시점의 아직 채굴되지 않은 BTC',
        '미채굴량(반감기)':'이번 4년 반감기 동안 채굴될 수 있는 BTC ',
        '일일채굴량': '하루에 가능한 최대 채굴량',
        // …etc for each heading you want a message for
      };      
      
      for (const key in entry) {
        let value = entry[key];
        const hintText = hints[key];
        
        const icon = hintText
          ? `<span class="tooltip-trigger">?
              <div class="tooltip-content">${hintText}"</div>
              </span>`
          : '';
          html += `<tr>
            <th>${key}${icon}</th>
            <td>${value}</td>
          </tr>`;
      }
      html += '</table>';
      infoDiv.innerHTML = html;
      setupTooltips();
    }

    function setupTooltips() {
      const tooltipTriggers = infoDiv.querySelectorAll('.tooltip-trigger');

      tooltipTriggers.forEach(trigger => {
          trigger.addEventListener('click', function(event) {
              event.stopPropagation();
  
              if (activeTooltip && activeTooltip !== this) {
                  activeTooltip.classList.remove('active');
              }
  
              this.classList.toggle('active');
              activeTooltip = this.classList.contains('active') ? this : null;
          });
      });
    }

    document.addEventListener('click', function(event) {
      // If there's an active tooltip and the click was outside of it
      if (activeTooltip && !activeTooltip.contains(event.target)) {
        activeTooltip.classList.remove('active');
        activeTooltip = null; // Reset active tooltip
      }
    });

    // Optional: Close tooltip on scroll
    window.addEventListener('scroll', function() {
      if (activeTooltip) {
        activeTooltip.classList.remove('active');
        activeTooltip = null;
      }
    });
    
    function renderPercentTable(entry) {
      const btcAmt = parseFloat(btcInput.value);
      if (isNaN(btcAmt)) {
        percentageDiv.innerHTML = '';
        return;
      }
      const fields = ['채굴보상(btc)', '총채굴량', '미채굴량(총)', '미채굴량(반감기)', '일일채굴량'];
      let html = '<h2>내 BTC는 미래에 채굴현황에 비해 어느정도 힘을 가지고 있을까?</h2><table>';
      fields.forEach(f => {
        const raw = parseFloat((entry[f] || '').replace(/,/g, '')) || 0;
        const pct = raw > 0 ? ((btcAmt / raw) * 100).toFixed(2) : 'N/A';
        html += `<tr><th>${f}</th><td>${pct}%</td></tr>`;
      });
      html += '</table>';
      percentageDiv.innerHTML = html;
    }
  </script>
  
  <footer>
  <p>Made by: <a href="https://x.com/juhwang8378">@juhwang8378</a></p>
  <p>정보 빼돌리지 않으니까 걱정마세요 <a href="https://github.com/juhwang8378/bitcoin-age/tree/main">(코드 확인)</a></p>
  <p>주의: 본 자료는 엄밀한 수학적 검증이 되지 않았습니다. 재미로만 이용해주시길 바랍니다.</p>
</footer>
</body>
</html>
